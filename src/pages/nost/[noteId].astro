---
import Editor from "src/components/nost/editor.astro";
import Og from "src/components/shared/head/og.astro";
import NostLayout from "src/components/shared/layout/nost-layout.astro";
import hashids from "src/lib/hashids";
import supabase from "src/lib/supabase";
import removeHTMLTags from "src/lib/utilities/remove-html-tag";

const { noteId } = Astro.params;
const id = hashids.decode(noteId!).pop();
if (id === undefined) {
	return Astro.redirect("/nost", 303);
}
const { data, count } = await supabase
	.from("nost")
	.select("content, views")
	.eq("id", id);
const row = data?.pop();
if (count === 1) {
	await supabase.from("nost").update({ view: row!.views + 1 });
}

const content = row?.content || "";
const description = removeHTMLTags(content.slice(0, 200));
---

<NostLayout note-id={noteId}>
	<Og slot="head" title={noteId} description={description} />
	<Editor content={content} />
</NostLayout>
